@model ECommerceProject.Models.ProductListViewModel

@{
    ViewData["Title"] = "Danh sách sản phẩm";
}

<!-- CSS Riêng cho trang này (Inline cho tiện) -->
<style>
    /* Mặc định: Ẩn bớt, chỉ hiện 5 mục đầu (chiều cao khoảng 200px), ẩn thanh cuộn */
    .category-list-collapsed {
        max-height: 200px;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
    }

    /* Khi mở rộng: Tăng chiều cao tối đa, hiện thanh cuộn dọc */
    .category-list-expanded {
        max-height: 400px; /* Chiều cao tối đa khi mở */
        overflow-y: auto; /* Hiện thanh cuộn nếu danh sách dài hơn 400px */
    }

        /* Tùy chỉnh thanh cuộn cho đẹp (Webkit browsers) */
        .category-list-expanded::-webkit-scrollbar {
            width: 5px;
        }

        .category-list-expanded::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
</style>

<div class="container mt-4">
    <div class="row">
        <!-- ================= SIDEBAR ================= -->
        <div class="col-md-3 mb-4">
            <!-- 1. Danh mục sản phẩm (CÓ NÚT XEM THÊM) -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="fas fa-list me-2"></i>Danh mục
                </div>

                <!-- ID categoryList để JS thao tác -->
                <div id="categoryList" class="list-group list-group-flush category-list-collapsed">
                    <a asp-action="Index" asp-route-categoryId=""
                       class="list-group-item list-group-item-action @(Model.CurrentCategoryId == null ? "active" : "")">
                        Tất cả sản phẩm
                    </a>
                    @foreach (var category in Model.Categories)
                    {
                        <a asp-action="Index" asp-route-categoryId="@category.CategoryId"
                           class="list-group-item list-group-item-action @(Model.CurrentCategoryId == category.CategoryId ? "active" : "")">
                            @category.CategoryName
                        </a>
                    }
                </div>

                <!-- Nút Xem thêm / Thu gọn -->
                <!-- Chỉ hiện nút nếu danh mục nhiều hơn 5 cái -->
                @if (Model.Categories.Count() > 5)
                {
                    <div class="card-footer text-center p-0">
                        <button onclick="toggleCategory()" id="btnToggleCategory" class="btn btn-link text-decoration-none btn-sm w-100 py-2">
                            Xem thêm <i class="fas fa-chevron-down ms-1"></i>
                        </button>
                    </div>
                }
            </div>

            <!-- 2. Lọc theo giá (GIỮ NGUYÊN) -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white fw-bold">
                    <i class="fas fa-filter me-2"></i>Lọc theo giá
                </div>
                <div class="card-body">
                    <form asp-action="Index" method="get">
                        @if (Model.CurrentCategoryId.HasValue)
                        {
                            <input type="hidden" name="categoryId" value="@Model.CurrentCategoryId" />
                        }
                        <div class="mb-3">
                            <label class="small text-muted">Thấp nhất</label>
                            <input type="number" name="minPrice" class="form-control" value="@Model.MinPrice">
                        </div>
                        <div class="mb-3">
                            <label class="small text-muted">Cao nhất</label>
                            <input type="number" name="maxPrice" class="form-control" value="@Model.MaxPrice">
                        </div>
                        <div class="mb-3">
                            <label class="small text-muted">Sắp xếp</label>
                            <select name="sortOrder" class="form-select">
                                <option value="">Mới nhất</option>
                                <option value="price_asc">Giá tăng dần</option>
                                <option value="price_desc">Giá giảm dần</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-success">Áp dụng</button>
                            <a asp-action="Index" class="btn btn-link text-decoration-none mt-2 btn-sm">Xóa bộ lọc</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ================= MAIN CONTENT ================= -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                <h4 class="fw-bold text-dark m-0">
                    @(Model.CurrentCategoryId != null
                                        ? Model.Categories.FirstOrDefault(c => c.CategoryId == Model.CurrentCategoryId)?.CategoryName
                                        : "Tất cả sản phẩm")
                </h4>
                <span class="badge bg-secondary">Trang @Model.CurrentPage / @Model.TotalPages</span>
            </div>

            @if (Model.Products.Any())
            {
                <div class="row">
                    @foreach (var item in Model.Products)
                    {
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 shadow-sm border-0 hover-shadow">
                                <div style="height: 200px; overflow: hidden; position: relative;">
                                    <img src="~/images/@item.ImageUrl" class="card-img-top" alt="@item.ProductName"
                                         style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title text-truncate">
                                        <a asp-action="Details" asp-route-id="@item.ProductId" class="text-decoration-none text-dark fw-bold">
                                            @item.ProductName
                                        </a>
                                    </h6>
                                    <p class="card-text text-primary fw-bold">@item.Price.ToString("#,##0") VNĐ</p>
                                    <div class="mt-auto d-grid gap-2">
                                        <a asp-controller="Cart" asp-action="AddToCart" asp-route-id="@item.ProductId" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-cart-plus"></i> Thêm vào giỏ
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- PHÂN TRANG (Pagination) -->
                <!-- Chỉ hiện nếu có nhiều hơn 1 trang -->
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mt-4">
                            <!-- Nút Previous -->
                            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage - 1, categoryId = Model.CurrentCategoryId, minPrice = Model.MinPrice, maxPrice = Model.MaxPrice, sortOrder = Model.SortOrder, searchString = Model.SearchString })">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>

                            <!-- Các nút số trang -->
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="page-item @(Model.CurrentPage == i ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { page = i, categoryId = Model.CurrentCategoryId, minPrice = Model.MinPrice, maxPrice = Model.MaxPrice, sortOrder = Model.SortOrder, searchString = Model.SearchString })">
                                        @i
                                    </a>
                                </li>
                            }

                            <!-- Nút Next -->
                            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage + 1, categoryId = Model.CurrentCategoryId, minPrice = Model.MinPrice, maxPrice = Model.MaxPrice, sortOrder = Model.SortOrder, searchString = Model.SearchString })">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="alert alert-warning text-center py-5">
                    <h5>Không tìm thấy sản phẩm nào!</h5>
                </div>
            }
        </div>
    </div>
</div>

<!-- Script xử lý nút Xem thêm/Thu gọn danh mục -->
<script>
    function toggleCategory() {
        var list = document.getElementById("categoryList");
        var btn = document.getElementById("btnToggleCategory");

        // Kiểm tra xem đang đóng hay mở
        if (list.classList.contains("category-list-collapsed")) {
            // Đang đóng -> Mở ra
            list.classList.remove("category-list-collapsed");
            list.classList.add("category-list-expanded");
            btn.innerHTML = 'Thu gọn <i class="fas fa-chevron-up ms-1"></i>';
        } else {
            // Đang mở -> Đóng lại
            list.classList.remove("category-list-expanded");
            list.classList.add("category-list-collapsed");
            btn.innerHTML = 'Xem thêm <i class="fas fa-chevron-down ms-1"></i>';

            // Cuộn nhẹ lên đầu danh sách để người dùng không bị lạc
            list.scrollTop = 0;
        }
    }
</script>